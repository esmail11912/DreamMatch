<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>DreamMatch — AppsGeyser</title>
  <style>
    * { box-sizing: border-box; }
    :root { --bg:#0b1020; --panel:#111735; --line:#1f2a52; --muted:#9aa4bf; --text:#e6e8ef; --primary:#2e44ff; --danger:#ff9aa2; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { padding: max(12px, env(safe-area-inset-top)) 16px 12px 16px; position:sticky; top:0; background:#0c1226cc; backdrop-filter: blur(8px); border-bottom:1px solid #1e2746; display:flex; align-items:center; gap:10px; justify-content:space-between; z-index:10 }
    h1 { font-size:20px; margin:0 }
    .sub { color: var(--muted); font-size:12px }
    main { padding:16px; max-width: 1100px; margin: 0 auto; }
    .grid { display:grid; grid-template-columns:1.1fr .9fr; gap:14px }
    .card { background: var(--panel); border:1px solid var(--line); border-radius:14px; padding:14px }
    .card h2 { margin:0 0 10px; font-size:16px }
    label { display:block; font-size:12px; color: var(--muted); margin:8px 0 4px }
    input, select, textarea { width:100%; border-radius:10px; border:1px solid #293563; background:#0f1533; color:var(--text); padding:10px 12px; outline:none }
    textarea { min-height:120px; resize:vertical }
    button { cursor:pointer; border:1px solid #2b3a72; background:#1a2350; color:var(--text); padding:10px 14px; border-radius:12px; font-weight:600 }
    .primary { background:var(--primary); border-color:var(--primary); color:#fff }
    .ghost { background:transparent }
    .danger { color:var(--danger) }
    .muted { color: var(--muted); font-size:12px }
    .list { display:grid; gap:10px; max-height: 440px; overflow:auto; padding-right:4px }
    .item { border:1px solid #223067; background:#0f1533; border-radius:12px; padding:10px }
    .item h3 { margin:0 0 6px; font-size:14px }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#1d2859; border:1px solid #2b3a72; color:#c7d2fe; font-size:11px; margin-left:6px }
    .sep { height:1px; background:#1e2746; margin:12px 0 }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:8px }
    .row2 { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .empty { border:1px dashed #2b3a72; padding:16px; border-radius:12px; text-align:center; color: var(--muted) }
    .snack { position:fixed; bottom: max(16px, env(safe-area-inset-bottom)); right:16px; background:#0f1533; border:1px solid #2b3a72; padding:10px 14px; border-radius:12px; color:var(--text); opacity:0; transform: translateY(8px); transition: all .25s ease; pointer-events:none; z-index:20 }
    .snack.show { opacity:1; transform: translateY(0); }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr } }
  </style>
</head>
<body>
<header>
  <div>
    <h1>DreamMatch</h1>
    <div class="row2" style="margin-top:6px">
      <label for="lang" class="muted" id="label_lang">Language</label>
      <select id="lang">
        <option value="en">English</option>
        <option value="fa">فارسی</option>
        <option value="ar">العربية</option>
        <option value="tr">Türkçe</option>
        <option value="de">Deutsch</option>
        <option value="fr">Français</option>
        <option value="es">Español</option>
        <option value="it">Italiano</option>
        <option value="pt">Português</option>
        <option value="ru">Русский</option>
        <option value="hi">हिन्दी</option>
        <option value="ja">日本語</option>
        <option value="ko">한국어</option>
        <option value="zh">简体中文</option>
      </select>
    </div>
  </div>
  <div class="row2">
    <span class="muted" id="authStatus">Signed out</span>
    <button id="btnOpenAuth" class="ghost">Sign in / Sign up</button>
    <button id="btnLogout" class="ghost" style="display:none">Sign out</button>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2 id="h_add">Add a Dream</h2>
      <form id="dreamForm">
        <label id="lab_title">Title (optional)</label>
        <input id="title" type="text" placeholder="e.g., Flying over a neon city" />
        <label id="lab_text">Dream text</label>
        <textarea id="text" placeholder="Write what you remember..."></textarea>

        <div class="row">
          <div>
            <label id="lab_date">Date</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label id="lab_mood">Mood</label>
            <select id="mood">
              <option value="">—</option>
              <option value="calm">Calm</option>
              <option value="happy">Happy</option>
              <option value="weird">Weird</option>
              <option value="scary">Scary</option>
              <option value="sad">Sad</option>
              <option value="excited">Excited</option>
            </select>
          </div>
        </div>

        <label id="lab_tags">Tags (comma separated)</label>
        <input id="tags" type="text" placeholder="stairs, ocean, running" />

        <label id="lab_vis">Visibility</label>
        <select id="visibility">
          <option value="public" data-en="Public (searchable by everyone)" data-fa="عمومی (قابل جستجو برای همه)">Public (searchable by everyone)</option>
          <option value="private" data-en="Private (only you)" data-fa="خصوصی (فقط خودت)">Private (only you)</option>
        </select>

        <div class="row2" style="margin-top:8px">
          <button type="submit" class="primary" id="btnSave">Save</button>
          <button type="button" id="btnSearch">Find Similar (Global)</button>
          <button type="button" id="btnClear" class="ghost">Clear</button>
          <span class="muted" id="hint"></span>
        </div>
      </form>

      <div class="sep"></div>
      <h2 id="h_results">Search Results</h2>
      <div id="similarList" class="list"></div>
      <div id="similarEmpty" class="empty" style="display:none">No results yet.</div>
    </section>

    <section class="card">
      <h2 id="h_profile">My Profile</h2>
      <form id="profileForm">
        <label id="lab_name">Name</label>
        <input id="p_name" type="text" placeholder="Your display name" />
        <label id="lab_bio">Bio</label>
        <input id="p_bio" type="text" placeholder="A short line about you" />
        <label id="lab_avatar">Avatar URL</label>
        <input id="p_avatar" type="text" placeholder="https://..." />
        <div class="row2" style="margin-top:8px">
          <button type="submit" id="btnSaveProfile">Save Profile</button>
          <button type="button" id="btnReloadMe" class="ghost">Reload</button>
        </div>
      </form>

      <div class="sep"></div>
      <h2 id="h_mine">My Dreams</h2>
      <div class="row2">
        <input id="searchMine" type="text" placeholder="Filter my dreams..." />
        <button id="btnReloadMine">Reload</button>
      </div>
      <div id="myList" class="list"></div>
      <div id="myEmpty" class="empty" style="display:none">No dreams yet.</div>

      <div class="sep"></div>
      <h2 id="h_public">Recent Dreams (Public)</h2>
      <div class="row2">
        <input id="searchAll" type="text" placeholder="Quick filter..." />
        <button id="btnReloadAll">Reload</button>
      </div>
      <div id="allList" class="list"></div>
      <div id="allEmpty" class="empty" style="display:none">No dreams yet.</div>
    </section>
  </div>
</main>

<!-- Auth modal -->
<div id="authModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); align-items:center; justify-content:center;">
  <div class="card" style="width:420px; max-width:92vw">
    <h2 id="h_auth">Sign in / Sign up</h2>
    <label id="lab_email">Email</label>
    <input id="a_email" type="text" placeholder="you@example.com" />
    <label id="lab_pass">Password</label>
    <input id="a_password" type="password" placeholder="••••••••" />
    <label id="lab_name_signup">Name (for signup)</label>
    <input id="a_name" type="text" placeholder="Optional" />
    <div class="row2" style="margin-top:8px">
      <button id="btnDoLogin" class="primary">Sign in</button>
      <button id="btnDoSignup">Sign up</button>
      <button id="btnCloseAuth" class="ghost">Close</button>
    </div>
    <div class="muted" style="margin-top:6px" id="authNote">Accounts are stored on the server.</div>
  </div>
</div>

<div id="snack" class="snack"></div>

<script>
  const BASE_URL = "https://dreammatch-production.up.railway.app";
  const TOKEN = () => localStorage.getItem('dm_token') || '';
  const headers = () => TOKEN() ? { 'Content-Type':'application/json', 'Authorization':'Bearer ' + TOKEN() } : { 'Content-Type':'application/json' };

  const I18N = {
  en:{langLabel:"Language",signedOut:"Signed out",openAuth:"Sign in / Sign up",signOut:"Sign out",
      add:"Add a Dream",title:"Title (optional)",titlePh:"e.g., Flying over a neon city",
      text:"Dream text",textPh:"Write what you remember...",date:"Date",mood:"Mood",
      tags:"Tags (comma separated)",tagsPh:"stairs, ocean, running",vis:"Visibility",
      visPublic:"Public (searchable by everyone)",visPrivate:"Private (only you)",
      save:"Save",findSim:"Find Similar (Global)",clear:"Clear",results:"Search Results",
      noResults:"No results yet.",profile:"My Profile",name:"Name",namePh:"Your display name",
      bio:"Bio",bioPh:"A short line about you",avatar:"Avatar URL",saveProfile:"Save Profile",
      reload:"Reload",mine:"My Dreams",filterMinePh:"Filter my dreams...",noMine:"No dreams yet.",
      pub:"Recent Dreams (Public)",filterAllPh:"Quick filter...",noAll:"No results yet.",
      authTitle:"Sign in / Sign up",email:"Email",pass:"Password",nameSignup:"Name (for signup)",
      nameSignupPh:"Optional",doLogin:"Sign in",doSignup:"Sign up",close:"Close",
      accountsNote:"Accounts are stored on the server.",alerts:{needEmailPass:"Email and password are required",
      needText:"Please write the dream text",needLogin:"Please sign in first",savedServer:"Saved to server",
      signedIn:"Signed in",signedOut:"Signed out",signedUp:"Signed up",profileSaved:"Profile saved"},
      visBadgePublic:"Public",visBadgePrivate:"Private",untitled:"Untitled dream",similarity:"Similarity",
      moods:{calm:"Calm",happy:"Happy",weird:"Weird",scary:"Scary",sad:"Sad",excited:"Excited"}},
  fa:{langLabel:"زبان",signedOut:"وارد نشده",openAuth:"ورود/ثبت‌نام",signOut:"خروج",
      add:"ثبت خواب",title:"عنوان (دلخواه)",titlePh:"مثلاً پرواز روی شهر",
      text:"متن خواب",textPh:"هر چی یادت میاد بنویس...",date:"تاریخ",mood:"حال‌وهوا",
      tags:"تگ‌ها (با کاما جدا)",tagsPh:"پله، دریا، دویدن",vis:"نمایش",
      visPublic:"عمومی (قابل جستجو برای همه)",visPrivate:"خصوصی (فقط خودت)",
      save:"ذخیره",findSim:"جستجوی مشابه (جهانی)",clear:"پاک کردن فرم",results:"نتایج جستجو",
      noResults:"فعلاً نتیجه‌ای نیست.",profile:"پروفایل من",name:"نام",namePh:"اسم نمایشی",
      bio:"معرفی",bioPh:"یه جمله کوتاه",avatar:"آواتار (URL)",saveProfile:"ذخیره پروفایل",
      reload:"بازخوانی",mine:"خواب‌های من",filterMinePh:"فیلتر خواب‌های من...",noMine:"هنوز خوابی ثبت نکردی.",
      pub:"خواب‌های اخیر (عمومی)",filterAllPh:"جستجوی سریع...",noAll:"چیزی نیست هنوز.",
      authTitle:"ورود / ثبت‌نام",email:"ایمیل",pass:"رمز عبور",nameSignup:"نام (برای ثبت‌نام)",
      nameSignupPh:"دلخواه",doLogin:"ورود",doSignup:"ثبت‌نام",close:"بستن",
      accountsNote:"حساب‌ها روی سرور ذخیره می‌شوند.",alerts:{needEmailPass:"ایمیل و رمز لازم است",
      needText:"متن خواب را بنویس",needLogin:"اول وارد شو",savedServer:"روی سرور ذخیره شد",
      signedIn:"وارد شدی",signedOut:"خارج شدی",signedUp:"ثبت‌نام موفق",profileSaved:"پروفایل ذخیره شد"},
      visBadgePublic:"عمومی",visBadgePrivate:"خصوصی",untitled:"بدون عنوان",similarity:"شباهت",
      moods:{calm:"آرام",happy:"شاد",weird:"عجیب",scary:"ترسناک",sad:"غمگین",excited:"هیجان‌انگیز"}},
  ar:{langLabel:"اللغة",signedOut:"غير مسجل",openAuth:"تسجيل الدخول / إنشاء حساب",signOut:"تسجيل الخروج",
      add:"أضف حلماً",title:"العنوان (اختياري)",titlePh:"مثال: التحليق فوق مدينة",
      text:"نص الحلم",textPh:"اكتب ما تتذكره...",date:"التاريخ",mood:"المزاج",
      tags:"وسوم (مفصولة بفواصل)",tagsPh:"درج، محيط، جري",vis:"الظهور",
      visPublic:"عام (قابل للبحث للجميع)",visPrivate:"خاص (فقط أنت)",
      save:"حفظ",findSim:"ابحث عن أحلام مشابهة",clear:"مسح",results:"نتائج البحث",
      noResults:"لا توجد نتائج بعد.",profile:"ملفي",name:"الاسم",namePh:"اسم العرض",
      bio:"نبذة",bioPh:"جملة قصيرة",avatar:"رابط الصورة",saveProfile:"حفظ الملف",
      reload:"تحديث",mine:"أحلامي",filterMinePh:"تصفية أحلامي...",noMine:"لا توجد أحلام بعد.",
      pub:"أحلام عامة حديثة",filterAllPh:"تصفية سريعة...",noAll:"لا شيء بعد.",
      authTitle:"تسجيل الدخول / التسجيل",email:"البريد الإلكتروني",pass:"كلمة المرور",
      nameSignup:"الاسم (للتسجيل)",nameSignupPh:"اختياري",doLogin:"تسجيل الدخول",doSignup:"تسجيل",
      close:"إغلاق",accountsNote:"يتم تخزين الحسابات في الخادم.",
      alerts:{needEmailPass:"البريد وكلمة المرور مطلوبان",needText:"يرجى كتابة نص الحلم",
      needLogin:"الرجاء تسجيل الدخول أولاً",savedServer:"تم الحفظ على الخادم",signedIn:"تم تسجيل الدخول",
      signedOut:"تم تسجيل الخروج",signedUp:"تم إنشاء الحساب",profileSaved:"تم حفظ الملف"},
      visBadgePublic:"عام",visBadgePrivate:"خاص",untitled:"بدون عنوان",similarity:"التشابه",
      moods:{calm:"هادئ",happy:"سعيد",weird:"غريب",scary:"مخيف",sad:"حزين",excited:"متحمس"}},
  tr:{langLabel:"Dil",signedOut:"Çıkış yapıldı",openAuth:"Giriş / Kayıt",signOut:"Çıkış",
      add:"Rüya Ekle",title:"Başlık (isteğe bağlı)",titlePh:"Örn: Neon şehirde uçmak",
      text:"Rüya metni",textPh:"Hatırladıklarını yaz...",date:"Tarih",mood:"Ruh hali",
      tags:"Etiketler (virgülle)",tagsPh:"merdiven, okyanus, koşu",vis:"Görünürlük",
      visPublic:"Herkese açık",visPrivate:"Özel (yalnızca sen)",
      save:"Kaydet",findSim:"Benzerlerini Bul",clear:"Temizle",results:"Arama Sonuçları",
      noResults:"Henüz sonuç yok.",profile:"Profilim",name:"İsim",namePh:"Görünen ad",
      bio:"Biyografi",bioPh:"Kısa bir cümle",avatar:"Avatar URL",saveProfile:"Profili Kaydet",
      reload:"Yenile",mine:"Rüyalarım",filterMinePh:"Rüyalarımı filtrele...",noMine:"Henüz rüya yok.",
      pub:"Son Genel Rüyalar",filterAllPh:"Hızlı filtre...",noAll:"Henüz yok.",
      authTitle:"Giriş / Kayıt",email:"E-posta",pass:"Şifre",nameSignup:"İsim (kayıt)",
      nameSignupPh:"İsteğe bağlı",doLogin:"Giriş",doSignup:"Kayıt",close:"Kapat",
      accountsNote:"Hesaplar sunucuda saklanır.",alerts:{needEmailPass:"E-posta ve şifre gerekli",
      needText:"Lütfen rüya metnini yazın",needLogin:"Lütfen önce giriş yapın",savedServer:"Sunucuya kaydedildi",
      signedIn:"Giriş yapıldı",signedOut:"Çıkış yapıldı",signedUp:"Kayıt olundu",profileSaved:"Profil kaydedildi"},
      visBadgePublic:"Herkese açık",visBadgePrivate:"Özel",untitled:"Başlıksız rüya",similarity:"Benzerlik",
      moods:{calm:"Sakin",happy:"Mutlu",weird:"Tuhaf",scary:"Korkutucu",sad:"Üzgün",excited:"Heyecanlı"}},
  de:{langLabel:"Sprache",signedOut:"Abgemeldet",openAuth:"Anmelden / Registrieren",signOut:"Abmelden",
      add:"Traum hinzufügen",title:"Titel (optional)",titlePh:"z.B. Über einer Stadt fliegen",
      text:"Traumtext",textPh:"Schreibe, was du erinnerst...",date:"Datum",mood:"Stimmung",
      tags:"Tags (durch Komma)",tagsPh:"Treppen, Ozean, Laufen",vis:"Sichtbarkeit",
      visPublic:"Öffentlich",visPrivate:"Privat (nur du)",
      save:"Speichern",findSim:"Ähnliche finden",clear:"Leeren",results:"Suchergebnisse",
      noResults:"Noch keine Ergebnisse.",profile:"Mein Profil",name:"Name",namePh:"Anzeigename",
      bio:"Bio",bioPh:"Kurzer Satz",avatar:"Avatar-URL",saveProfile:"Profil speichern",
      reload:"Neu laden",mine:"Meine Träume",filterMinePh:"Meine Träume filtern...",noMine:"Noch keine Träume.",
      pub:"Öffentliche Träume (neu)",filterAllPh:"Schnell filtern...",noAll:"Noch nichts.",
      authTitle:"Anmelden / Registrieren",email:"E-Mail",pass:"Passwort",nameSignup:"Name (für Registrierung)",
      nameSignupPh:"Optional",doLogin:"Anmelden",doSignup:"Registrieren",close:"Schließen",
      accountsNote:"Konten werden auf dem Server gespeichert.",alerts:{needEmailPass:"E-Mail und Passwort erforderlich",
      needText:"Bitte Traumtext schreiben",needLogin:"Bitte zuerst anmelden",savedServer:"Auf Server gespeichert",
      signedIn:"Angemeldet",signedOut:"Abgemeldet",signedUp:"Registriert",profileSaved:"Profil gespeichert"},
      visBadgePublic:"Öffentlich",visBadgePrivate:"Privat",untitled:"Ohne Titel",similarity:"Ähnlichkeit",
      moods:{calm:"Ruhig",happy:"Glücklich",weird:"Seltsam",scary:"Gruselig",sad:"Traurig",excited:"Aufgeregt"}},
  fr:{langLabel:"Langue",signedOut:"Déconnecté",openAuth:"Se connecter / S’inscrire",signOut:"Se déconnecter",
      add:"Ajouter un rêve",title:"Titre (optionnel)",titlePh:"ex. Voler au-dessus d'une ville",
      text:"Texte du rêve",textPh:"Écris ce dont tu te souviens...",date:"Date",mood:"Humeur",
      tags:"Tags (séparés par des virgules)",tagsPh:"escaliers, océan, course",vis:"Visibilité",
      visPublic:"Public",visPrivate:"Privé (toi seul)",
      save:"Enregistrer",findSim:"Trouver des similaires",clear:"Effacer",results:"Résultats",
      noResults:"Aucun résultat pour l’instant.",profile:"Mon profil",name:"Nom",namePh:"Nom d’affichage",
      bio:"Bio",bioPh:"Courte phrase",avatar:"URL de l’avatar",saveProfile:"Enregistrer le profil",
      reload:"Recharger",mine:"Mes rêves",filterMinePh:"Filtrer mes rêves...",noMine:"Aucun rêve pour l’instant.",
      pub:"Rêves publics récents",filterAllPh:"Filtre rapide...",noAll:"Rien pour l’instant.",
      authTitle:"Connexion / Inscription",email:"E-mail",pass:"Mot de passe",nameSignup:"Nom (pour inscription)",
      nameSignupPh:"Optionnel",doLogin:"Connexion",doSignup:"Inscription",close:"Fermer",
      accountsNote:"Les comptes sont stockés sur le serveur.",alerts:{needEmailPass:"E-mail et mot de passe requis",
      needText:"Écris le texte du rêve",needLogin:"Connecte-toi d’abord",savedServer:"Enregistré sur le serveur",
      signedIn:"Connecté",signedOut:"Déconnecté",signedUp:"Inscrit",profileSaved:"Profil enregistré"},
      visBadgePublic:"Public",visBadgePrivate:"Privé",untitled:"Sans titre",similarity:"Similarité",
      moods:{calm:"Calme",happy:"Heureux",weird:"Étrange",scary:"Effrayant",sad:"Triste",excited:"Excité"}},
  es:{langLabel:"Idioma",signedOut:"Desconectado",openAuth:"Iniciar sesión / Registrarse",signOut:"Cerrar sesión",
      add:"Añadir un sueño",title:"Título (opcional)",titlePh:"p. ej., Volar sobre una ciudad",
      text:"Texto del sueño",textPh:"Escribe lo que recuerdes...",date:"Fecha",mood:"Estado de ánimo",
      tags:"Etiquetas (separadas por comas)",tagsPh:"escaleras, océano, correr",vis:"Visibilidad",
      visPublic:"Público",visPrivate:"Privado (solo tú)",
      save:"Guardar",findSim:"Encontrar similares",clear:"Limpiar",results:"Resultados de búsqueda",
      noResults:"Aún no hay resultados.",profile:"Mi perfil",name:"Nombre",namePh:"Nombre para mostrar",
      bio:"Bio",bioPh:"Frase corta",avatar:"URL del avatar",saveProfile:"Guardar perfil",
      reload:"Recargar",mine:"Mis sueños",filterMinePh:"Filtrar mis sueños...",noMine:"Aún no hay sueños.",
      pub:"Sueños públicos recientes",filterAllPh:"Filtro rápido...",noAll:"Nada aún.",
      authTitle:"Iniciar sesión / Registrarse",email:"Correo",pass:"Contraseña",nameSignup:"Nombre (para registro)",
      nameSignupPh:"Opcional",doLogin:"Entrar",doSignup:"Registrarse",close:"Cerrar",
      accountsNote:"Cuentas en el servidor.",alerts:{needEmailPass:"Correo y contraseña requeridos",
      needText:"Escribe el texto del sueño",needLogin:"Primero inicia sesión",savedServer:"Guardado en el servidor",
      signedIn:"Conectado",signedOut:"Desconectado",signedUp:"Registrado",profileSaved:"Perfil guardado"},
      visBadgePublic:"Público",visBadgePrivate:"Privado",untitled:"Sin título",similarity:"Similitud",
      moods:{calm:"Tranquilo",happy:"Feliz",weird:"Raro",scary:"De miedo",sad:"Triste",excited:"Emocionado"}},
  it:{langLabel:"Lingua",signedOut:"Disconnesso",openAuth:"Accedi / Registrati",signOut:"Esci",
      add:"Aggiungi un sogno",title:"Titolo (facoltativo)",titlePh:"es. Volare su una città",
      text:"Testo del sogno",textPh:"Scrivi ciò che ricordi...",date:"Data",mood:"Umore",
      tags:"Tag (separati da virgole)",tagsPh:"scale, oceano, corsa",vis:"Visibilità",
      visPublic:"Pubblico",visPrivate:"Privato (solo tu)",
      save:"Salva",findSim:"Trova simili",clear:"Pulisci",results:"Risultati",
      noResults:"Nessun risultato.",profile:"Il mio profilo",name:"Nome",namePh:"Nome visualizzato",
      bio:"Bio",bioPh:"Frase breve",avatar:"URL avatar",saveProfile:"Salva profilo",
      reload:"Ricarica",mine:"I miei sogni",filterMinePh:"Filtra i miei sogni...",noMine:"Ancora nessun sogno.",
      pub:"Sogni pubblici recenti",filterAllPh:"Filtro rapido...",noAll:"Niente ancora.",
      authTitle:"Accedi / Registrati",email:"Email",pass:"Password",nameSignup:"Nome (per registrazione)",
      nameSignupPh:"Opzionale",doLogin:"Accedi",doSignup:"Registrati",close:"Chiudi",
      accountsNote:"Account memorizzati sul server.",alerts:{needEmailPass:"Email e password richieste",
      needText:"Scrivi il testo del sogno",needLogin:"Accedi prima",savedServer:"Salvato sul server",
      signedIn:"Connesso",signedOut:"Disconnesso",signedUp:"Registrato",profileSaved:"Profilo salvato"},
      visBadgePublic:"Pubblico",visBadgePrivate:"Privato",untitled:"Senza titolo",similarity:"Somiglianza",
      moods:{calm:"Calmo",happy:"Felice",weird:"Strano",scary:"Spaventoso",sad:"Triste",excited:"Eccitato"}},
  pt:{langLabel:"Idioma",signedOut:"Desconectado",openAuth:"Entrar / Registrar",signOut:"Sair",
      add:"Adicionar um sonho",title:"Título (opcional)",titlePh:"ex.: Voando sobre a cidade",
      text:"Texto do sonho",textPh:"Escreva o que lembrar...",date:"Data",mood:"Humor",
      tags:"Tags (separadas por vírgulas)",tagsPh:"escadas, oceano, corrida",vis:"Visibilidade",
      visPublic:"Público",visPrivate:"Privado (só você)",
      save:"Salvar",findSim:"Encontrar similares",clear:"Limpar",results:"Resultados da busca",
      noResults:"Sem resultados ainda.",profile:"Meu perfil",name:"Nome",namePh:"Nome de exibição",
      bio:"Bio",bioPh:"Frase curta",avatar:"URL do avatar",saveProfile:"Salvar perfil",
      reload:"Recarregar",mine:"Meus sonhos",filterMinePh:"Filtrar meus sonhos...",noMine:"Nenhum sonho ainda.",
      pub:"Sonhos públicos recentes",filterAllPh:"Filtro rápido...",noAll:"Nada ainda.",
      authTitle:"Entrar / Registrar",email:"E-mail",pass:"Senha",nameSignup:"Nome (para registro)",
      nameSignupPh:"Opcional",doLogin:"Entrar",doSignup:"Registrar",close:"Fechar",
      accountsNote:"Contas armazenadas no servidor.",alerts:{needEmailPass:"E-mail e senha obrigatórios",
      needText:"Escreva o texto do sonho",needLogin:"Entre primeiro",savedServer:"Salvo no servidor",
      signedIn:"Conectado",signedOut:"Desconectado",signedUp:"Registrado",profileSaved:"Perfil salvo"},
      visBadgePublic:"Público",visBadgePrivate:"Privado",untitled:"Sem título",similarity:"Similaridade",
      moods:{calm:"Calmo",happy:"Feliz",weird:"Estranho",scary:"Assustador",sad:"Triste",excited:"Animado"}},
  ru:{langLabel:"Язык",signedOut:"Вышли",openAuth:"Вход / Регистрация",signOut:"Выйти",
      add:"Добавить сон",title:"Заголовок (необязательно)",titlePh:"напр., Летать над городом",
      text:"Текст сна",textPh:"Напишите, что помните...",date:"Дата",mood:"Настроение",
      tags:"Теги (через запятую)",tagsPh:"лестница, океан, бег",vis:"Видимость",
      visPublic:"Публичный",visPrivate:"Приватный (только вы)",
      save:"Сохранить",findSim:"Найти похожие",clear:"Очистить",results:"Результаты поиска",
      noResults:"Пока нет результатов.",profile:"Мой профиль",name:"Имя",namePh:"Отображаемое имя",
      bio:"Био",bioPh:"Короткая фраза",avatar:"Ссылка аватара",saveProfile:"Сохранить профиль",
      reload:"Обновить",mine:"Мои сны",filterMinePh:"Фильтр моих снов...",noMine:"Пока нет снов.",
      pub:"Недавние публичные сны",filterAllPh:"Быстрый фильтр...",noAll:"Пока ничего.",
      authTitle:"Вход / Регистрация",email:"Email",pass:"Пароль",nameSignup:"Имя (для регистрации)",
      nameSignupPh:"Необязательно",doLogin:"Войти",doSignup:"Регистрация",close:"Закрыть",
      accountsNote:"Учетные записи на сервере.",alerts:{needEmailPass:"Нужны email и пароль",
      needText:"Пожалуйста, напишите текст сна",needLogin:"Сначала войдите",savedServer:"Сохранено на сервере",
      signedIn:"Вход выполнен",signedOut:"Выход выполнен",signedUp:"Зарегистрированы",profileSaved:"Профиль сохранен"},
      visBadgePublic:"Публичный",visBadgePrivate:"Приватный",untitled:"Без названия",similarity:"Сходство",
      moods:{calm:"Спокойный",happy:"Счастливый",weird:"Странный",scary:"Страшный",sad:"Грустный",excited:"Взволнованный"}},
  hi:{langLabel:"भाषा",signedOut:"साइन आउट",openAuth:"साइन इन / साइन अप",signOut:"साइन आउट",
      add:"एक सपना जोड़ें",title:"शीर्षक (वैकल्पिक)",titlePh:"जैसे, शहर के ऊपर उड़ना",
      text:"सपने का पाठ",textPh:"जो याद है लिखें...",date:"तारीख",mood:"मूड",
      tags:"टैग (कॉमा से)",tagsPh:"सीढ़ियाँ, सागर, दौड़",vis:"दृश्यता",
      visPublic:"सार्वजनिक",visPrivate:"निजी (सिर्फ आप)",
      save:"सेव",findSim:"समान खोजें",clear:"क्लियर",results:"खोज परिणाम",
      noResults:"अभी कोई परिणाम नहीं।",profile:"मेरा प्रोफ़ाइल",name:"नाम",namePh:"प्रदर्शित नाम",
      bio:"बायो",bioPh:"छोटी पंक्ति",avatar:"अवतार URL",saveProfile:"प्रोफ़ाइल सेव",
      reload:"रीलोड",mine:"मेरे सपने",filterMinePh:"मेरे सपनों को फ़िल्टर करें...",noMine:"अभी कोई सपना नहीं।",
      pub:"हाल के सार्वजनिक सपने",filterAllPh:"त्वरित फ़िल्टर...",noAll:"अभी कुछ नहीं।",
      authTitle:"साइन इन / साइन अप",email:"ईमेल",pass:"पासवर्ड",nameSignup:"नाम (साइन अप हेतु)",
      nameSignupPh:"वैकल्पिक",doLogin:"साइन इन",doSignup:"साइन अप",close:"बंद करें",
      accountsNote:"खाते सर्वर पर संग्रहीत हैं।",alerts:{needEmailPass:"ईमेल और पासवर्ड आवश्यक",
      needText:"कृपया सपना लिखें",needLogin:"पहले साइन इन करें",savedServer:"सर्वर पर सेव",
      signedIn:"साइन इन हो गया",signedOut:"साइन आउट हो गया",signedUp:"साइन अप हो गया",profileSaved:"प्रोफ़ाइल सेव"},
      visBadgePublic:"सार्वजनिक",visBadgePrivate:"निजी",untitled:"शीर्षक रहित",similarity:"समानता",
      moods:{calm:"शांत",happy:"खुश",weird:"अजीब",scary:"डरावना",sad:"उदास",excited:"उत्साहित"}},
  ja:{langLabel:"言語",signedOut:"サインアウト",openAuth:"サインイン / 登録",signOut:"サインアウト",
      add:"夢を追加",title:"タイトル（任意）",titlePh:"例：街の上を飛ぶ",
      text:"夢のテキスト",textPh:"覚えていることを書いて...",date:"日付",mood:"気分",
      tags:"タグ（カンマ区切り）",tagsPh:"階段, 海, ランニング",vis:"公開範囲",
      visPublic:"公開",visPrivate:"非公開（自分のみ）",
      save:"保存",findSim:"類似を探す",clear:"クリア",results:"検索結果",
      noResults:"まだ結果はありません。",profile:"マイプロフィール",name:"名前",namePh:"表示名",
      bio:"自己紹介",bioPh:"短い一文",avatar:"アバターURL",saveProfile:"プロフィール保存",
      reload:"再読込",mine:"自分の夢",filterMinePh:"夢を絞り込み...",noMine:"まだ夢がありません。",
      pub:"最近の公開された夢",filterAllPh:"クイックフィルター...",noAll:"まだありません。",
      authTitle:"サインイン / 登録",email:"メール",pass:"パスワード",nameSignup:"名前（登録）",
      nameSignupPh:"任意",doLogin:"サインイン",doSignup:"登録",close:"閉じる",
      accountsNote:"アカウントはサーバーに保存されます。",alerts:{needEmailPass:"メールとパスワードが必要です",
      needText:"夢のテキストを書いてください",needLogin:"先にサインインしてください",savedServer:"サーバーに保存しました",
      signedIn:"サインインしました",signedOut:"サインアウトしました",signedUp:"登録しました",profileSaved:"プロフィールを保存しました"},
      visBadgePublic:"公開",visBadgePrivate:"非公開",untitled:"無題",similarity:"類似度",
      moods:{calm:"穏やか",happy:"幸せ",weird:"奇妙",scary:"怖い",sad:"悲しい",excited:"ワクワク"}},
  ko:{langLabel:"언어",signedOut:"로그아웃됨",openAuth:"로그인 / 가입",signOut:"로그아웃",
      add:"꿈 추가",title:"제목 (선택)",titlePh:"예: 도시 위를 비행",
      text:"꿈 내용",textPh:"기억나는 것을 적으세요...",date:"날짜",mood:"기분",
      tags:"태그(쉼표로 구분)",tagsPh:"계단, 바다, 달리기",vis:"공개 범위",
      visPublic:"공개",visPrivate:"비공개(본인만)",
      save:"저장",findSim:"유사 찾기",clear:"지우기",results:"검색 결과",
      noResults:"아직 결과가 없어요.",profile:"내 프로필",name:"이름",namePh:"표시 이름",
      bio:"소개",bioPh:"짧은 한 줄",avatar:"아바타 URL",saveProfile:"프로필 저장",
      reload:"새로고침",mine:"내 꿈",filterMinePh:"내 꿈 필터...",noMine:"아직 꿈이 없어요.",
      pub:"최근 공개 꿈",filterAllPh:"빠른 필터...",noAll:"아직 없어요.",
      authTitle:"로그인 / 가입",email:"이메일",pass:"비밀번호",nameSignup:"이름(가입)",
      nameSignupPh:"선택",doLogin:"로그인",doSignup:"가입",close:"닫기",
      accountsNote:"계정은 서버에 저장됩니다.",alerts:{needEmailPass:"이메일과 비밀번호가 필요해요",
      needText:"꿈 내용을 작성해 주세요",needLogin:"먼저 로그인하세요",savedServer:"서버에 저장됨",
      signedIn:"로그인됨",signedOut:"로그아웃됨",signedUp:"가입 완료",profileSaved:"프로필 저장됨"},
      visBadgePublic:"공개",visBadgePrivate:"비공개",untitled:"제목 없음",similarity:"유사도",
      moods:{calm:"차분함",happy:"행복",weird:"이상함",scary:"무서움",sad:"슬픔",excited:"설렘"}},
  zh:{langLabel:"语言",signedOut:"未登录",openAuth:"登录 / 注册",signOut:"退出登录",
      add:"添加梦境",title:"标题（可选）",titlePh:"例：飞在城市上空",
      text:"梦境内容",textPh:"写下你记得的...",date:"日期",mood:"心情",
      tags:"标签（逗号分隔）",tagsPh:"楼梯, 海洋, 跑步",vis:"可见性",
      visPublic:"公开（所有人可搜索）",visPrivate:"私密（仅自己）",
      save:"保存",findSim:"查找相似",clear:"清空",results:"搜索结果",
      noResults:"暂无结果。",profile:"我的资料",name:"名字",namePh:"显示名称",
      bio:"简介",bioPh:"一句简短的话",avatar:"头像URL",saveProfile:"保存资料",
      reload:"重新加载",mine:"我的梦",filterMinePh:"筛选我的梦...",noMine:"暂无梦境。",
      pub:"最新公开梦境",filterAllPh:"快速筛选...",noAll:"暂无。",
      authTitle:"登录 / 注册",email:"邮箱",pass:"密码",nameSignup:"名字（注册用）",
      nameSignupPh:"可选",doLogin:"登录",doSignup:"注册",close:"关闭",
      accountsNote:"账户存储在服务器上。",alerts:{needEmailPass:"需要邮箱和密码",
      needText:"请填写梦境内容",needLogin:"请先登录",savedServer:"已保存到服务器",
      signedIn:"已登录",signedOut:"已退出",signedUp:"已注册",profileSaved:"资料已保存"},
      visBadgePublic:"公开",visBadgePrivate:"私密",untitled:"无标题",similarity:"相似度",
      moods:{calm:"平静",happy:"开心",weird:"奇怪",scary:"可怕",sad:"难过",excited:"兴奋"}}
  };

  function setDir(lang){ const rtl = ['fa','ar']; document.documentElement.dir = rtl.includes(lang)?'rtl':'ltr'; document.documentElement.lang = lang; }
  function t(lang){ return I18N[lang] || I18N.en; }

  const els = {
    lang: document.getElementById('lang'),
    label_lang: document.getElementById('label_lang'),
    authStatus: document.getElementById('authStatus'),
    btnOpenAuth: document.getElementById('btnOpenAuth'),
    btnLogout: document.getElementById('btnLogout'),
    h_add: document.getElementById('h_add'),
    lab_title: document.getElementById('lab_title'),
    title: document.getElementById('title'),
    lab_text: document.getElementById('lab_text'),
    text: document.getElementById('text'),
    lab_date: document.getElementById('lab_date'),
    date: document.getElementById('date'),
    lab_mood: document.getElementById('lab_mood'),
    mood: document.getElementById('mood'),
    lab_tags: document.getElementById('lab_tags'),
    tags: document.getElementById('tags'),
    lab_vis: document.getElementById('lab_vis'),
    visibility: document.getElementById('visibility'),
    btnSave: document.getElementById('btnSave'),
    btnSearch: document.getElementById('btnSearch'),
    btnClear: document.getElementById('btnClear'),
    hint: document.getElementById('hint'),
    h_results: document.getElementById('h_results'),
    similarList: document.getElementById('similarList'),
    similarEmpty: document.getElementById('similarEmpty'),
    h_profile: document.getElementById('h_profile'),
    lab_name: document.getElementById('lab_name'),
    p_name: document.getElementById('p_name'),
    lab_bio: document.getElementById('lab_bio'),
    p_bio: document.getElementById('p_bio'),
    lab_avatar: document.getElementById('lab_avatar'),
    p_avatar: document.getElementById('p_avatar'),
    btnSaveProfile: document.getElementById('btnSaveProfile'),
    btnReloadMe: document.getElementById('btnReloadMe'),
    h_mine: document.getElementById('h_mine'),
    searchMine: document.getElementById('searchMine'),
    btnReloadMine: document.getElementById('btnReloadMine'),
    myList: document.getElementById('myList'),
    myEmpty: document.getElementById('myEmpty'),
    h_public: document.getElementById('h_public'),
    searchAll: document.getElementById('searchAll'),
    btnReloadAll: document.getElementById('btnReloadAll'),
    allList: document.getElementById('allList'),
    allEmpty: document.getElementById('allEmpty'),
    authModal: document.getElementById('authModal'),
    h_auth: document.getElementById('h_auth'),
    lab_email: document.getElementById('lab_email'),
    a_email: document.getElementById('a_email'),
    lab_pass: document.getElementById('lab_pass'),
    a_password: document.getElementById('a_password'),
    lab_name_signup: document.getElementById('lab_name_signup'),
    a_name: document.getElementById('a_name'),
    btnDoLogin: document.getElementById('btnDoLogin'),
    btnDoSignup: document.getElementById('btnDoSignup'),
    btnCloseAuth: document.getElementById('btnCloseAuth'),
    authNote: document.getElementById('authNote'),
    snack: document.getElementById('snack')
  };

  function applyLang(lang){
    const i = t(lang);
    els.label_lang.textContent = i.langLabel;
    els.authStatus.textContent = TOKEN() ? (lang==='fa' ? 'وارد شده' : i.signedIn || 'Signed in') : i.signedOut;
    els.btnOpenAuth.textContent = i.openAuth;
    els.btnLogout.textContent = i.signOut;

    els.h_add.textContent = i.add;
    els.lab_title.textContent = i.title; els.title.placeholder = i.titlePh;
    els.lab_text.textContent = i.text; els.text.placeholder = i.textPh;
    els.lab_date.textContent = i.date;
    els.lab_mood.textContent = i.mood;
    els.lab_tags.textContent = i.tags; els.tags.placeholder = i.tagsPh || i.tags;
    els.lab_vis.textContent = i.vis;

    // mood labels
    const iM = (i.moods||I18N.en.moods);
    const moodOptions = els.mood.querySelectorAll('option');
    moodOptions.forEach(opt=>{
      if (!opt.value) return;
      if (iM[opt.value]) opt.textContent = iM[opt.value];
    });

    Array.from(els.visibility.options).forEach(opt=>{
      if (opt.dataset && opt.dataset[lang]) opt.textContent = opt.dataset[lang];
      else if (opt.value==='public') opt.textContent = i.visPublic;
      else if (opt.value==='private') opt.textContent = i.visPrivate;
    });

    els.btnSave.textContent = i.save;
    els.btnSearch.textContent = i.findSim;
    els.btnClear.textContent = i.clear;

    els.h_results.textContent = i.results;
    els.similarEmpty.textContent = i.noResults;

    els.h_profile.textContent = i.profile;
    els.lab_name.textContent = i.name; els.p_name.placeholder = i.namePh;
    els.lab_bio.textContent = i.bio; els.p_bio.placeholder = i.bioPh;
    els.lab_avatar.textContent = i.avatar;
    els.btnSaveProfile.textContent = i.saveProfile;
    els.btnReloadMe.textContent = i.reload;

    els.h_mine.textContent = i.mine;
    els.searchMine.placeholder = i.filterMinePh;
    els.btnReloadMine.textContent = i.reload;
    els.myEmpty.textContent = i.noMine;

    els.h_public.textContent = i.pub;
    els.searchAll.placeholder = i.filterAllPh;
    els.btnReloadAll.textContent = i.reload;
    els.allEmpty.textContent = i.noAll;

    els.h_auth.textContent = i.authTitle;
    els.lab_email.textContent = i.email;
    els.lab_pass.textContent = i.pass;
    els.lab_name_signup.textContent = i.nameSignup;
    els.a_name.placeholder = i.nameSignupPh;
    els.btnDoLogin.textContent = i.doLogin;
    els.btnDoSignup.textContent = i.doSignup;
    els.btnCloseAuth.textContent = i.close;
    els.authNote.textContent = i.accountsNote;

    setDir(lang);
  }

  // detect browser language, or use saved one
  const LANG_KEY = 'dm_lang';
  const supported = Object.keys(I18N);
  const nav = (navigator.language||navigator.userLanguage||'en').slice(0,2).toLowerCase();
  const initial = localStorage.getItem(LANG_KEY) || (supported.includes(nav)? nav : 'en');
  els.lang.value = initial;
  applyLang(initial);
  els.lang.addEventListener('change', ()=>{ localStorage.setItem(LANG_KEY, els.lang.value); applyLang(els.lang.value); });

  function snack(msg){ els.snack.textContent = msg; els.snack.classList.add('show'); setTimeout(()=> els.snack.classList.remove('show'), 2200); }
  function today(){ return new Date().toISOString().slice(0,10); }
  function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
  document.getElementById('date').value = today();

  // Auth
  document.getElementById('btnOpenAuth').addEventListener('click', ()=> els.authModal.style.display = 'flex');
  document.getElementById('btnCloseAuth').addEventListener('click', ()=> els.authModal.style.display='none');
  document.getElementById('btnLogout').addEventListener('click', async ()=>{
    try { await fetch(BASE_URL + '/auth/logout', { method:'POST', headers: headers() }); } catch(e){}
    localStorage.removeItem('dm_token');
    els.authStatus.textContent = t(els.lang.value).signedOut;
    document.getElementById('btnLogout').style.display='none';
    snack(t(els.lang.value).alerts.signedOut);
  });

  document.getElementById('btnDoSignup').addEventListener('click', async ()=>{
    const i = t(els.lang.value);
    const payload = { email: document.getElementById('a_email').value.trim(), password: document.getElementById('a_password').value, name: document.getElementById('a_name').value.trim() };
    if (!payload.email || !payload.password){ alert(i.alerts.needEmailPass); return; }
    const res = await fetch(BASE_URL + '/auth/signup', { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const data = await res.json().catch(()=>({}));
    if (!res.ok){ alert(data.error || 'Signup failed'); return; }
    localStorage.setItem('dm_token', data.token);
    els.authModal.style.display='none';
    els.authStatus.textContent = i.signedIn || 'Signed in';
    document.getElementById('btnLogout').style.display='';
    snack(i.alerts.signedUp);
  });

  document.getElementById('btnDoLogin').addEventListener('click', async ()=>{
    const i = t(els.lang.value);
    const payload = { email: document.getElementById('a_email').value.trim(), password: document.getElementById('a_password').value };
    if (!payload.email || !payload.password){ alert(i.alerts.needEmailPass); return; }
    const res = await fetch(BASE_URL + '/auth/login', { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const data = await res.json().catch(()=>({}));
    if (!res.ok){ alert(data.error || 'Login failed'); return; }
    localStorage.setItem('dm_token', data.token);
    els.authModal.style.display='none';
    els.authStatus.textContent = i.signedIn || 'Signed in';
    document.getElementById('btnLogout').style.display='';
    snack(i.alerts.signedIn);
  });

  // Profile
  async function loadMe(clear=false){
    if (clear){ els.p_name.value=''; els.p_bio.value=''; els.p_avatar.value=''; return; }
    if (!TOKEN()) return;
    const res = await fetch(BASE_URL + '/me', { headers: { 'Authorization':'Bearer ' + TOKEN() } }).catch(()=>null);
    if (!res || !res.ok) return;
    const me = await res.json();
    els.p_name.value = me.name || '';
    els.p_bio.value = me.bio || '';
    els.p_avatar.value = me.avatar_url || '';
  }
  document.getElementById('profileForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const i = t(els.lang.value);
    if (!TOKEN()){ alert(i.alerts.needLogin); return; }
    const payload = { name: els.p_name.value.trim(), bio: els.p_bio.value.trim(), avatar_url: els.p_avatar.value.trim() };
    const res = await fetch(BASE_URL + '/me', { method:'PUT', headers: headers(), body: JSON.stringify(payload) });
    if (!res.ok){ alert('Could not save profile'); return; }
    snack(i.alerts.profileSaved);
  });
  document.getElementById('btnReloadMe').addEventListener('click', ()=> loadMe());

  // Save Dream
  document.getElementById('dreamForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const i = t(els.lang.value);
    if (!TOKEN()){ alert(i.alerts.needLogin); return; }
    const payload = {
      title: els.title.value.trim(),
      text: els.text.value.trim(),
      date: els.date.value,
      mood: els.mood.value,
      tags: els.tags.value.trim(),
      visibility: els.visibility.value
    };
    if (!payload.text){ alert(i.alerts.needText); return; }
    const res = await fetch(BASE_URL + '/dreams', { method:'POST', headers: headers(), body: JSON.stringify(payload) }).catch(()=>null);
    if (!res || !res.ok){ alert('Save failed'); return; }
    els.hint.textContent = i.alerts.savedServer;
    document.getElementById('dreamForm').reset(); document.getElementById('date').value = new Date().toISOString().slice(0,10);
    loadMine(); loadRecent();
  });
  document.getElementById('btnClear').addEventListener('click', ()=>{
    document.getElementById('dreamForm').reset();
    document.getElementById('date').value=new Date().toISOString().slice(0,10);
    els.text.focus();
  });

  function renderListInto(arr, container, emptyEl, q, mine=false){
    container.innerHTML='';
    const data = (q? arr.filter(d =>
      (d.title||'').toLowerCase().includes(q.toLowerCase()) ||
      (d.text||'').toLowerCase().includes(q.toLowerCase()) ||
      (d.tags||'').toLowerCase().includes(q.toLowerCase())
    ) : arr);
    if (data.length===0){ emptyEl.style.display='block'; return; }
    emptyEl.style.display='none';
    const i = t(els.lang.value);
    data.forEach(d=>{
      const div = document.createElement('div'); div.className='item';
      const vis = d.visibility ? `<span class="pill">${d.visibility==='private'? i.visBadgePrivate : i.visBadgePublic}</span>`:'';
      div.innerHTML = `
        <h3>${esc(d.title)||i.untitled}</h3>
        <div class="muted">${esc(d.date||'—')} · ${(d.mood||'')} ${vis}</div>
        <div class="muted" style="margin-top:6px">${esc(String(d.text||'')).slice(0,180)}${(d.text||'').length>180?'…':''}</div>
      `;
      if (mine){
        const btns = document.createElement('div'); btns.className='row2'; btns.style.marginTop='8px';
        const del = document.createElement('button'); del.textContent= els.lang.value==='fa' ? 'حذف' : 'Delete'; del.className='ghost danger';
        del.addEventListener('click', async ()=>{
          if (!confirm(els.lang.value==='fa' ? 'حذف شود؟' : 'Delete this dream?')) return;
          const res = await fetch(BASE_URL + '/dreams/' + d.id, { method:'DELETE', headers: { 'Authorization':'Bearer ' + TOKEN() } });
          if (res.ok){ loadMine(); } else { alert('Delete failed'); }
        });
        btns.appendChild(del); div.appendChild(btns);
      }
      container.appendChild(div);
    });
  }

  async function loadMine(){
    if (!TOKEN()){ els.myEmpty.style.display='block'; els.myList.innerHTML=''; return; }
    const res = await fetch(BASE_URL + '/dreams?mine=true&limit=100', { headers: { 'Authorization':'Bearer ' + TOKEN() } }).catch(()=>null);
    if (!res || !res.ok){ els.myEmpty.style.display='block'; els.myList.innerHTML=''; return; }
    const arr = await res.json();
    renderListInto(arr, els.myList, els.myEmpty, els.searchMine.value.trim(), true);
  }
  document.getElementById('btnReloadMine').addEventListener('click', loadMine);
  document.getElementById('searchMine').addEventListener('input', loadMine);

  async function loadRecent(){
    const res = await fetch(BASE_URL + '/dreams?limit=100').catch(()=>null);
    if (!res || !res.ok){ els.allEmpty.style.display='block'; els.allList.innerHTML=''; return; }
    const arr = await res.json();
    renderListInto(arr, els.allList, els.allEmpty, els.searchAll.value.trim());
  }
  document.getElementById('btnReloadAll').addEventListener('click', loadRecent);
  document.getElementById('searchAll').addEventListener('input', loadRecent);

  document.getElementById('btnSearch').addEventListener('click', async ()=>{
    const i = t(els.lang.value);
    const q = (els.title.value + ' ' + els.text.value + ' ' + els.tags.value).trim();
    if (!q){ alert(i.alerts.needText); return; }
    els.similarList.innerHTML=''; els.similarEmpty.style.display='none';
    const res = await fetch(BASE_URL + '/dreams/search?q=' + encodeURIComponent(q), { headers: TOKEN() ? { 'Authorization':'Bearer ' + TOKEN() } : {} }).catch(()=>null);
    if (!res || !res.ok){ els.similarEmpty.style.display='block'; return; }
    const items = await res.json();
    renderSimilar(items.map(it=>({ ref: it.ref, score: it.score })));
  });

  function renderSimilar(items){
    els.similarList.innerHTML='';
    const i = t(els.lang.value);
    if (!items.length || (items[0].score||0)===0){ els.similarEmpty.style.display='block'; return; }
    items.forEach(({ref, score})=>{
      const div = document.createElement('div'); div.className='item';
      const pct = (score*100).toFixed(1);
      const vis = ref.visibility ? `<span class="pill">${ref.visibility==='private'? i.visBadgePrivate : i.visBadgePublic}</span>`:'';
      div.innerHTML = `
        <h3>${esc(ref.title)||i.untitled}</h3>
        <div class="muted">${esc(ref.date||'—')} · ${(ref.mood||'')} ${vis}</div>
        <div class="muted" style="margin-top:6px">${esc(String(ref.text||'')).slice(0,220)}${(ref.text||'').length>220?'…':''}</div>
        <div style="margin-top:8px">${i.similarity}: <b>${pct}%</b></div>
      `;
      els.similarList.appendChild(div);
    });
  }

  // init
  loadMe(); loadMine(); loadRecent();
</script>
</body>
</html>
